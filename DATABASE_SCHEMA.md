# 데이터베이스 스키마 문서

## 개요
이 문서는 Persona Insight 플랫폼의 데이터베이스 스키마에 대한 포괄적인 분석을 제공하며, 테이블 사용 현황, 관계, 비즈니스 목적을 자세히 설명합니다.

**데이터베이스 타입**: PostgreSQL (Supabase)  
**스키마**: `public`  
**아키텍처**: 회사별 데이터 격리를 지원하는 멀티테넌트 구조  
**전체 테이블 수**: 14개의 활성 테이블

## 테이블 사용 현황 및 카테고리

### 🏢 **핵심 멀티테넌시** (2개 테이블)
멀티테넌트 아키텍처의 기반을 형성하는 테이블들:

| 테이블 | 상태 | 주요 목적 |
|-------|--------|-----------------|
| `companies` | ✅ **활성** | 루트 테넌트 엔티티 - 회사별 데이터 격리 제공 |
| `profiles` | ✅ **활성** | Supabase Auth와 연결된 사용자 프로필 관리, 회사 역할 포함 |

### 👥 **프로젝트 관리** (3개 테이블)
유연한 프로젝트 협업을 지원하는 테이블들:

| 테이블 | 상태 | 주요 목적 |
|-------|--------|-----------------|
| `projects` | ✅ **활성** | 가시성 제어(공개/비공개)가 가능한 프로젝트 관리 |
| `project_members` | ✅ **활성** | 역할 기반 권한(소유자/관리자/멤버)을 통한 팀 협업 |
| `project_summaries` | ✅ **활성** | 버전 추적이 가능한 AI 생성 프로젝트 요약 |

### 📊 **인터뷰 관리** (3개 테이블)
핵심 인터뷰 처리 및 주석 시스템:

| 테이블 | 상태 | 주요 목적 |
|-------|--------|-----------------|
| `interviews` | ✅ **활성** | AI 분석 파이프라인을 포함한 향상된 인터뷰 처리, 페르소나 조합 할당 |
| `interview_notes` | ✅ **활성** | 스레드 기능을 가진 협업 인터뷰 주석 |
| `interview_note_replies` | ✅ **활성** | 인터뷰 노트에 대한 스레드 형식의 답글 |

### 🎭 **페르소나 시스템** (3개 테이블)
단순화된 페르소나 분류 체계:

| 테이블 | 상태 | 주요 목적 |
|-------|--------|-----------------|
| `persona_classifications` | ✅ **활성** | 회사별 페르소나 분류 기준 설정 |
| `persona_classification_types` | ✅ **활성** | 각 분류 기준의 구체적인 유형들 |
| `persona_combinations` | ✅ **활성** | 유형들의 조합으로 생성된 페르소나 (P1, P2, ...) |

### 📚 **지식 관리** (3개 테이블)
콘텐츠 및 정의 지원:

| 테이블 | 상태 | 주요 목적 |
|-------|--------|-----------------|
| `main_topics` | ✅ **활성** | 회사별 주요 토픽 관리 |
| `glossary` | ✅ **활성** | 회사별 용어 정의 |
| `key_takeaways` | ✅ **활성** | 인터뷰에서 추출한 핵심 인사이트 |

### 🔧 **유틸리티 테이블** (1개 테이블)
지원 기능:

| 테이블 | 상태 | 주요 목적 |
|-------|--------|-----------------|
| `script_sections` | ✅ **활성** | 인터뷰 스크립트 섹션 정의 |

## 주요 관계 및 데이터 흐름

### 멀티테넌트 계층 구조
```
companies (루트)
├── profiles (사용자)
├── projects
│   ├── project_members
│   ├── project_summaries
│   └── interviews (persona_combination_id로 페르소나 연결)
│       ├── interview_notes
│       └── interview_note_replies
├── persona_classifications
│   └── persona_classification_types
│       └── persona_combinations
├── main_topics
├── glossary
└── key_takeaways
```

### 권한 레벨
- **사용자 역할**: `super_admin` > `company_admin` > `company_user`
- **프로젝트 역할**: `owner` > `admin` > `member`

## 비즈니스 도메인 분석

### 🎯 **핵심 비즈니스 기능**

**인터뷰 분석 파이프라인**:
1. 파일 업로드 → `interviews` 테이블
2. MISO API를 통한 AI 처리
3. 토픽 추출 → `main_topics`
4. 페르소나 조합 할당 → `persona_combinations`에 연결

**페르소나 관리**:
- `persona_classifications`에서 회사별 분류 기준 설정
- `persona_classification_types`에서 각 분류의 유형 정의
- `persona_combinations`에서 유형 조합 자동 생성
- 인터뷰를 적절한 페르소나 조합에 할당

**협업 기능**:
- 역할 기반 접근 권한을 가진 팀 프로젝트
- 실시간 인터뷰 주석
- 인터뷰 콘텐츠에 대한 스레드 형식의 토론

### 📈 **성능 고려사항**

**활성 사용 패턴**:
- `interviews`와 `persona_combinations` 간의 효율적인 연결
- `interview_notes`의 빈번한 업데이트 (실시간 협업)
- 단순화된 페르소나 조합 기반 분석

**최적화 기능**:
- 25개 이상의 특수 데이터베이스 인덱스
- 복잡한 JSON 쿼리를 위한 JSONB GIN 인덱스
- 성능이 중요한 작업을 위한 RPC 함수
- 일반적인 필터 조합을 위한 부분 인덱스

## 마이그레이션 현황

### ✅ **완료된 마이그레이션**
- `interviewees` → `interviews` 마이그레이션 완료 (레거시 테이블 삭제됨)
- `persona_type_mappings` 마이그레이션 완료 (레거시 테이블 삭제됨)
- 페르소나 시스템 단순화 완료 (`personas`, `persona_definitions`, `persona_topic_documents` 삭제됨)

### 🔄 **진행 중인 최적화**
- 새로운 인덱스를 통한 성능 최적화
- 단순화된 페르소나 시스템 안정화

## 기술 구현 노트

### 사용된 데이터베이스 기능
- **JSONB 컬럼**: 인터뷰 데이터와 페르소나 메트릭을 위한 유연한 스키마
- **배열 타입**: 태그 목록과 관련 ID 저장용
- **열거형 타입**: 적절한 제약 조건을 가진 사용자 역할
- **소프트 삭제**: 감사 추적을 위한 `deleted_at`과 `deleted_by` 필드
- **RPC 함수**: 복잡한 비즈니스 로직을 데이터베이스 레벨로 이동
- **PGMQ**: 비동기 처리를 위한 메시지 큐

### 보안 및 규정 준수
- 회사 격리에 기반한 행 수준 보안(RLS)
- 생성/수정 타임스탬프를 포함한 감사 추적
- RPC 함수를 통한 사용자 권한 확인
- 데이터 보존을 위한 소프트 삭제 패턴

## 사용 권장사항

### 🟢 **활발히 사용 및 유지 관리 중**
모든 테이블이 프로덕션에서 활발히 사용되며 유지 관리되고 있습니다.

### 🔄 **향후 개선 사항**
1. 페르소나 분류 시스템 지속적 최적화
2. 인덱스 전략 개선을 통한 성능 향상
3. 실시간 협업 기능 확장

### 📊 **모니터링 권장사항**
- `interviews` 테이블 증가 모니터링 (주요 데이터 저장소)
- 실시간 협업 성능을 위한 `interview_notes` 감시
- `persona_combinations` 테이블을 통한 페르소나 할당 현황 추적
- 인터뷰별 페르소나 분포 모니터링

---

**최종 업데이트**: 2025-07-16  
**스키마 버전**: 현재 프로덕션 스키마  
**전체 활성 테이블**: 14개